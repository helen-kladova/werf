<p align="center">
  <img src="https://github.com/flant/werf/raw/master/docs/images/werf-logo.svg?sanitize=true" style="max-height:100%;" height="175">
</p>

<p align="center">
  <a href='https://bintray.com/flant/werf/werf/_latestVersion'><img src='https://api.bintray.com/packages/flant/werf/werf/images/download.svg'></a>
  <a href="https://godoc.org/github.com/flant/werf"><img src="https://godoc.org/github.com/flant/werf?status.svg" alt="GoDoc"></a>
  <a href="https://cloud-native.slack.com/messages/CHY2THYUU"><img src="https://img.shields.io/badge/slack-EN%20chat-611f69.svg?logo=slack" alt="Slack chat EN"></a>
  <a href="https://t.me/werf_ru"><img src="https://img.shields.io/badge/telegram-RU%20chat-179cde.svg?logo=telegram" alt="Telegram chat RU"></a>
</p>
___

<!-- WERF DOCS PARTIAL BEGIN: Overview -->

Werf — Open Source CLI утилита написанная на Golang, предназначенная для упрощения и ускорения доставки вашего приложения. Чтобы получить эффект  от Werf, вам нужно просто описать конфигурацию вашего приложения (правила его сборки и развертывания в Kubernetes) в Git-репозитории, выступающем в качестве единственного источника данных. Короче говоря, это то, что мы сегодня называем GitOps.

* Werf может собирать Docker-образы как используя Dockerfile'ы, так и альтернативный сборщиком с собственным синтаксисом, обладающим большей скоростью. Werf также очищает Docker-регистри от мусора (неиспользуемых образов).
* Werf развертывает ваше приложение в Kubernetes используя Helm-совместимый формат чартов с удобными настройками и улучшенным механизмом отслеживания процесса развертывания, обнаружения ошибок и выводом логов.

Хотя Werf — это не полноценная система CI/CD, но это инструмент, который можно встроить в любую существующую систему CI/CD, чтобы реализовать эго функционал для вашего прилжоения. Мы считаем инструменты такого рода — новым поколением высокоуровневых инструментов CI/CD.

<!-- WERF DOCS PARTIAL END -->

**Содержание**

- [Возможности](#возможности)
- [Установка](#установка)
  - [Установка зависимостей](#установка-зависимостей)
  - [Установка Werf](#установка-werf)
- [Обещание обратной совместимости](#обещание-обратной-совместимости)
- [Документация-и-поддержка](#документация-и-поддержка)
- [Лицензия](#лицензия)

# Возможности

<!-- WERF DOCS PARTIAL BEGIN: Features -->

 - Управление полным жизненным циклом приложения: сборка и публикация образов, деплой приложений в Kubernetes, очистка неиспользуемых образов по политикам.
 - Описание всех правил сборки и деплоя приложения (состоящего из любого количества компонентов) в одном git-репозитории с исходным кодом (single source of truth).
 - Сборка образов из Dockerfile'ов.
 - Альтернативный вариант сборки с использованием специального синтаксиса, чтобы получить преимущества Ansible-сборщика и инкрементальной сборки на основе истории изменений git.
 - Использование совместимых с Helm 2 чартов, а также комплексный деплой с журналированием, трэкингом, ранним выявлением ошибок и использованием аннотаций ресурсов для тонкой настройки процесса деплоя.
 - Werf — это CLI-утилита написанная на Golang, которая может быть встроена в любую существующую систему CI/CD.

## Скоро

- 3-х этапное слияние (3-way-merge) [#1616](https://github.com/flant/werf/issues/1616).
- Тэгирование по содержимому [#1184](https://github.com/flant/werf/issues/1184).
- Распределенная сборка с общим Docker-registry [#1614](https://github.com/flant/werf/issues/1614).

## Полный списко возможностей

### Сборка

- Удобная сборка любого числа образов в одном проекте.
- Сборка образов как из Dockerfile так и из инструкций сборщика Stapel.
- Параллельные сборки на одном хосте (с использованием файловых блокировок).
- Распределенная сборка (скоро) [#1614](https://github.com/flant/werf/issues/1614).
- Расширенная сборка со сборщиком Stapel:
  - Инкрементальная пересборка на основе истории изменений git.
  - Сборка образов с как с Shell-инструкциями так и с Ansible-заданиями.
  - Совместное использование кэша между сборками с использованием монтирования.
  - Уменьшение конечного размера образов с исключением исходного кода и инструментов сборки из образа.
- Сборка одного образа из конфигурации другого образа, описанных в одном файле конфигурации.
- Инструменты отладки сборочного процесса (интроспекция).
- Детализированный вывод.

### Публикация

- Хранение образов в одном или нескольких Docker-репозиториях согласно следующих шаблонов именования:
  - `IMAGES_REPO:[IMAGE_NAME-]TAG` в режиме `monorepo`.
  - `IMAGES_REPO[/IMAGE_NAME]:TAG` в режиме `multirepo`.
- Различные стратегии тэгирования образов:
  - Тжгирование образов по тэгу, ветке или коммиту в Git.
  - Тэгирование по содержимому (скоро) [#1184](https://github.com/flant/werf/issues/1184).

### Деплой

- Деплой приложений в Kubernetes и отслеживание что приложение развернуто корректно.
  - Отслеживание статуса всех ресурсов.
  - Контроль готовности ресурсов.
  - Управление контролем процесса деплоя с помощью аннотаций.
- Полный визуальный контроль как процесса деплоя так и конечного результата.
  - Логирование и сообщение об ошибках.
  - Вывод периодического отчета о состоянии ресурсов в процессе деплоя.
  - Упрощенная отладка проблем, без необходимости обращаться к kubectl.
- Завершение с ошибкой задания pipeline CI при обнаружении проблемы.
  - Раннее обнаружение ошибок деплоя ресурсов, без необходимости ждать таймаута.
- Полная совместимость с Helm 2.
- Возможность ограничения прав при развертывании с использованием механизма RBAC (Tiller встроен внутрь Werf и его запуск выпоняется от имени пользователя выполняющего деплой).
- Параллельные сборки на одном хосте (с использованием файловых блокировок).
- Распределенный параллельный деплой (скоро) [#1620](https://github.com/flant/werf/issues/1620).
- Возможность непрерывной доставки нового образа имеющего тоже-самое имя (стратегия тэгирования по веткам, как пример).

### Очистка

- Очистка локального хранилища и Docker-registry по настраиваемым политикам.
- Очистка оставляет образы используемые в кластере Kubernetes, для чего Werf сканирует следующие типы объектов кластера: Pod, Deployment, ReplicaSet, StatefulSet, DaemonSet, Job, CronJob, ReplicationController.

<!-- WERF DOCS PARTIAL END -->

# Установка

<!-- WERF DOCS PARTIAL BEGIN: Installation -->

## Установка зависимостей

### Docker

[Руководство по установке Docker CE](https://docs.docker.com/install/).

Для управления Docker от вашего пользователя без необходимости повышения привилегий создайте группу **docker** и добавьте в нее вашего пользователя:

```bash
sudo groupadd docker
sudo usermod -aG docker $USER
```

### Git

[Руководство по установке Git](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git).

- Минимально допустимая версия — 1.9.0.
- В случае использования [Git Submodule](https://git-scm.com/docs/gitsubmodules), минимально допустимая версия — 2.14.0.

## Установка Werf

### Метод 1 (рекомендовано): с использованием Multiwerf

[Multiwerf](https://github.com/flant/multiwerf) это менеджер версий для Werf, который:
* скачивает исполняемый файл Werf;
* управляет версиями Werf, установленными на одном и том-же хосте;
* автоматически обновляет исполняемый файл Werf (можно отключить).

```bash
# add ~/bin into PATH
echo 'export PATH=$PATH:$HOME/bin' >> ~/.bashrc
exec bash

# install multiwerf into ~/bin directory
mkdir -p ~/bin
cd ~/bin
curl -L https://raw.githubusercontent.com/flant/multiwerf/master/get.sh | bash
source <(multiwerf use 1.0 beta)
```

> _Замечание:_ Если вы используете bash версии < 4.0 (например для MacOS версия версия bash по умолчанию — 3.2), вы должны использовать команду `source /dev/stdin <<<"$(multiwerf use 1.0 beta)"` вместо `source <(multiwerf use 1.0 beta)`.

### Метод 2: скачать исполняемый файл

Самую актуалную версию можно скачать [здесь](https://bintray.com/flant/werf/werf/_latestVersion).

##### MacOS

```bash
curl -L https://dl.bintray.com/flant/werf/v1.0.3-beta.9/werf-darwin-amd64-v1.0.3-beta.9 -o /tmp/werf
chmod +x /tmp/werf
sudo mv /tmp/werf /usr/local/bin/werf
```

##### Linux

```bash
curl -L https://dl.bintray.com/flant/werf/v1.0.3-beta.9/werf-linux-amd64-v1.0.3-beta.9 -o /tmp/werf
chmod +x /tmp/werf
sudo mv /tmp/werf /usr/local/bin/werf
```

##### Windows

Скачайте [здесь](https://dl.bintray.com/flant/werf/v1.0.3-beta.9/werf-windows-amd64-v1.0.3-beta.9.exe).

### Метод 3: сборка из исходных кодов

```
go get github.com/flant/werf/cmd/werf
```

<!-- WERF DOCS PARTIAL END -->

# Обещание обратной совместимости

<!-- WERF DOCS PARTIAL BEGIN: Backward Compatibility Promise -->

> _Note:_ Настоящее обещание относится к Werf начиная с версии 1.0 и не относися к предыдущим версиям, или версиям dapp.

Для Werf принято [Семантическое версионирование](https://semver.org/lang/ru/). Это значит, что мажорные версии (1.0, 2.0) могут быть обратно не совместимыми между собой. В случае Werf это означает, что обновление на следующую мажорную версию _may_ потребовать полного передеплоя приложений либо других ручных операций.

Минорные версии (1.1, 1.2, etc.) могут добавлять новые "значительные" возможности, но без значительных проблем обратной совместимости в пределах мажорной версии. В случае Werf это означает, что обновление на следующую минорную версию в большинстве случаев будет беспроблемным, но _может_ потребовать запуска предлогаемых скриптов.

Патч-версии (1.1.0, 1.1.1, 1.1.2) могут добавлять новые возможности, но без каких-либо проблем обратной совметимости в пределах минорной версии (1.1.x).
В случае Werf это означает, что обновление на следующий патч (патч-версию) не должно вызывать проблем и каких-либо ручных действий.

Патч-версии делятся на каналы обюновлений. Канал обновлений — это префикс пререлизной части версии (1.1.0-alpha.2, 1.1.0-beta.3, 1.1.0-ea.1). Версия без пререлизной части считается версией стабильного канала обновлений.

- Канал обновления `stable` (1.1.0, 1.1.1, 1.1.2, etc.). Версии этого канала обновлений рекомендуется использовать в критичных окружениях с высоким SLA.
  Мы **гарантируем** обратную совместимость между версиями канала обновлений `stable` в пределах минорной версии (1.1.x).
- Канал обновления `ea` можно безопасность использовать, и мы рекомендуем использовать  этот канал обновлений везде.
  Мы **гарантируем** обратную совместимость между версиями канала обновлений `ea` в пределах минорной версии (1.1.x).
  Мы **гарантируем** что версия из канала обновлений `ea` перейдет в канал обновлений `stable` не ранее чем через 2 недели плотного тестирования.
- Канал обновления `rc` (2.3.2-rc.2). Версии этого канала обновлений обычно безопасно использовать даже в некритичных окружениях или при локальной разработке.
  Мы **не гарантируем** обратной совместимости между версиями канала обновлений `rc`.
  Мы **гарантируем** что версия с канала обновлений `rc` перейдет в канал обновлений `ea` не ранее чем через неделю после внутреннего тестирования.
- Канал обновления `beta` (1.2.2-beta.0). Версии этого канала предназначены для более глубокого тестирования новых возможностей.
  Мы **не гарантируем** обратной совместимости между версиями канала обновлений `beta`.
- Канал обновления `alpha` (1.2.2-alpha.12, 2.0.0-alpha.5, etc.). Версии этого канала обновлений могут содержать новые возможности, а также быть не стабильными, иметь ошибки.
  Мы **не гарантируем** обратной совместимости между версиями канала обновлений `alpha`.

<!-- WERF DOCS PARTIAL END -->

# Документация и поддержка

<!-- WERF DOCS PARTIAL BEGIN: Docs and support -->

[Создайте ваше первое приложение с Werf](https://werf.io/documentation/guides/getting_started.html) или начните знакомство с чтения [документации](https://werf.io/).

Разработчики Werf всегда поддерживают связь с сообществом. Присоединяйтесь к нам в Slack или Telegram!

- English-speaking community in [CNCF Slack channel #werf](https://cloud-native.slack.com/messages/CHY2THYUU)
- Русскоязычное сообщество — чат в Telegram [#werf_ru](https://t.me/werf_ru)

Мы внимательно рассматриваем ваши [issues](https://github.com/flant/werf/issues) на GitHub.

<!-- WERF DOCS PARTIAL END -->

# Лицензия

<!-- WERF DOCS PARTIAL BEGIN: License -->

Apache License 2.0, see [LICENSE](LICENSE)
